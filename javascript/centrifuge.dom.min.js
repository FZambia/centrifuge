(function(e){e.extend({centrifuge_dom:function(t){function o(e){r.debug===!0&&console.log(e)}function u(e){var t=0,n;for(n in e)e.hasOwnProperty(n)&&t++;return t}function a(e){return r.fullMessage===!1?e.data:e}function f(e){return r.fullMessage===!1?e.body:e}function l(e){return r.fullMessage===!1?e.error:e}function c(e,t){var n=e.attr(r.channelAttr),i=t.getSubscription(n);return i===null&&o("no subscription found for channel "+n),i}function h(e){e.on("connect",function(){o("connected to Centrifuge"),m(e)}),e.on("error",function(e){o(e)}),e.on("disconnect",function(){o("disconnected from Centrifuge"),g()})}function p(e){s.on(r.eventPrefix+"publish",function(t){var n=$(this),r=c(n,e);r&&r.publish(t)}),s.on(r.eventPrefix+"presence",function(){var t=$(this),n=c(t,e);n&&n.presence(function(e){t.trigger("centrifuge-presence-message",a(e))})}),s.on(r.eventPrefix+"history",function(){var t=$(this),n=c(t,e);n&&n.history(function(e){t.trigger("centrifuge-history-message",a(e))})}),s.on(r.eventPrefix+"unsubscribe",function(){var t=$(this),n=c(t,e);n&&n.unsubscribe()})}function d(e,t){var n=i[e],s=t.subscribe(e,function(e){o(e);var t=n.attr(r.messageEventNameAttr),i=r.eventPrefix+(t||"message");n.trigger(i,a(e))});s.on("subscribe:success",function(e){var t=r.eventPrefix+"subscribe:success";n.trigger(t,f(e))}),s.on("subscribe:error",function(e){o(e);var t=r.eventPrefix+"subscribe:error";n.trigger(t,l(e))}),s.on("join",function(e){o(e);var t=r.eventPrefix+"join";n.trigger(t,a(e))}),s.on("leave",function(e){o(e);var t=r.eventPrefix+"leave";n.trigger(t,a(e))})}function v(e){var t=i[e];t.trigger(r.eventPrefix+"disconnect")}function m(e){for(var t in i)d(t,e)}function g(){for(var e in i)v(e)}function y(t){s.each(function(t,n){var s=e(n),o=s.attr(r.channelAttr);i[o]=s})}function b(){if(!Centrifuge){console.log("No Centrifuge javascript client found");return}if(s.length===0){o("No Centrifuge handlers found on this page, nothing to do");return}var e=$(r.tokenSelector).attr(r.valueAttrName);if(!e){console.log("Centrifuge token not found");return}var t=$(r.projectSelector).attr(r.valueAttrName);if(!t){console.log("Centrifuge project not found");return}var n=$(r.userSelector).attr(r.valueAttrName);if(!n){console.log("Centrifuge user not found");return}var a=$(r.timestampSelector).attr(r.valueAttrName);if(!a){console.log("Centrifuge timestamp not found");return}var f;r.url===null&&(f=$(r.urlSelector).attr(r.valueAttrName));if(!f){console.log("Centrifuge connection url not found");return}var l=$(r.infoSelector).attr(r.valueAttrName);l||(o("Centrifuge info not used, token must be generated without info part."),l=null);var c=new Centrifuge({url:f,token:e,project:t,user:n,timestamp:a,info:l});y(c);if(u(i)===0){o("No valid handlers found on page, no need in connection to Centrifuge");return}h(c),p(c),c.connect()}var n={url:null,selector:".centrifuge",urlSelector:"#centrifuge-address",tokenSelector:"#centrifuge-token",projectSelector:"#centrifuge-project",userSelector:"#centrifuge-user",timestampSelector:"#centrifuge-timestamp",infoSelector:"#centrifuge-info",valueAttrName:"data-centrifuge-value",channelAttr:"data-centrifuge-channel",messageEventNameAttr:"data-centrifuge-message",eventPrefix:"centrifuge.",fullMessage:!0,debug:!1},r=e.extend(n,t),i={},s=e(r.selector);return b()}})})(jQuery);
