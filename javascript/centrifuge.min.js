(function(){"use strict";function e(e,t){return e.prototype=Object.create(t.prototype),e.prototype.constructor=e,t.prototype}function t(){}function r(e,t){var n=e.length;while(n--)if(e[n].listener===t)return n;return-1}function i(e){return function(){return this[e].apply(this,arguments)}}function s(e,t,n){var r=t||{};for(var i=2;i<arguments.length;++i){var u=arguments[i];if(u===undefined||u===null)continue;for(var a in u){var f=o(u,a),l=o(r,a);if(f===t)continue;if(f===undefined)continue;if(e&&typeof f=="object"&&f!==null)if(f instanceof Array)r[a]=s(e,l instanceof Array?l:[],f);else{var c=typeof l!="object"||l instanceof Array?{}:l;r[a]=s(e,c,f)}else r[a]=f}}return r}function o(e,t){try{return e[t]}catch(n){return undefined}}function u(e,t){return e.indexOf(t,e.length-t.length)!==-1}function a(e){return e.substring(e.length-1)=="/"&&(e=e.substring(0,e.length-1)),e}function f(e){return e===undefined||e===null?!1:typeof e=="string"||e instanceof String}function l(e){return e===undefined||e===null?!1:typeof e=="function"}function c(e,t){if(window.console){var n=window.console[e];l(n)&&n.apply(window.console,t)}}function h(e){this._sockjs=!1,this._status="disconnected",this._reconnect=!0,this._transport=null,this._messageId=0,this._clientId=null,this._subscriptions={},this._messages=[],this._isBatching=!1,this._config={retry:3e3,info:null,debug:!1,server:null,protocols_whitelist:["websocket","xdr-streaming","xhr-streaming","iframe-eventsource","iframe-htmlfile","xdr-polling","xhr-polling","iframe-xhr-polling","jsonp-polling"]},e&&this.configure(e)}function d(e,t){this._centrifuge=e,this.channel=t}Object.create||(Object.create=function(){function e(){}return function(t){if(arguments.length!=1)throw new Error("Object.create implementation only accepts one parameter.");return e.prototype=t,new e}}()),Array.prototype.indexOf||(Array.prototype.indexOf=function(e){if(this==null)throw new TypeError;var t,n,r=Object(this),i=r.length>>>0;if(i===0)return-1;t=0,arguments.length>1&&(t=Number(arguments[1]),t!=t?t=0:t!=0&&t!=Infinity&&t!=-Infinity&&(t=(t>0||-1)*Math.floor(Math.abs(t))));if(t>=i)return-1;for(n=t>=0?t:Math.max(i-Math.abs(t),0);n<i;n++)if(n in r&&r[n]===e)return n;return-1});var n=t.prototype;n.getListeners=function(t){var n=this._getEvents(),r,i;if(typeof t=="object"){r={};for(i in n)n.hasOwnProperty(i)&&t.test(i)&&(r[i]=n[i])}else r=n[t]||(n[t]=[]);return r},n.flattenListeners=function(t){var n=[],r;for(r=0;r<t.length;r+=1)n.push(t[r].listener);return n},n.getListenersAsObject=function(t){var n=this.getListeners(t),r;return n instanceof Array&&(r={},r[t]=n),r||n},n.addListener=function(t,n){var i=this.getListenersAsObject(t),s=typeof n=="object",o;for(o in i)i.hasOwnProperty(o)&&r(i[o],n)===-1&&i[o].push(s?n:{listener:n,once:!1});return this},n.on=i("addListener"),n.addOnceListener=function(t,n){return this.addListener(t,{listener:n,once:!0})},n.once=i("addOnceListener"),n.defineEvent=function(t){return this.getListeners(t),this},n.defineEvents=function(t){for(var n=0;n<t.length;n+=1)this.defineEvent(t[n]);return this},n.removeListener=function(t,n){var i=this.getListenersAsObject(t),s,o;for(o in i)i.hasOwnProperty(o)&&(s=r(i[o],n),s!==-1&&i[o].splice(s,1));return this},n.off=i("removeListener"),n.addListeners=function(t,n){return this.manipulateListeners(!1,t,n)},n.removeListeners=function(t,n){return this.manipulateListeners(!0,t,n)},n.manipulateListeners=function(t,n,r){var i,s,o=t?this.removeListener:this.addListener,u=t?this.removeListeners:this.addListeners;if(typeof n!="object"||n instanceof RegExp){i=r.length;while(i--)o.call(this,n,r[i])}else for(i in n)n.hasOwnProperty(i)&&(s=n[i])&&(typeof s=="function"?o.call(this,i,s):u.call(this,i,s));return this},n.removeEvent=function(t){var n=typeof t,r=this._getEvents(),i;if(n==="string")delete r[t];else if(n==="object")for(i in r)r.hasOwnProperty(i)&&t.test(i)&&delete r[i];else delete this._events;return this},n.emitEvent=function(t,n){var r=this.getListenersAsObject(t),i,s,o,u;for(o in r)if(r.hasOwnProperty(o)){s=r[o].length;while(s--)i=r[o][s],i.once===!0&&this.removeListener(t,i.listener),u=i.listener.apply(this,n||[]),u===this._getOnceReturnValue()&&this.removeListener(t,i.listener)}return this},n.trigger=i("emitEvent"),n.emit=function(t){var n=Array.prototype.slice.call(arguments,1);return this.emitEvent(t,n)},n.setOnceReturnValue=function(t){return this._onceReturnValue=t,this},n._getOnceReturnValue=function(){return this.hasOwnProperty("_onceReturnValue")?this._onceReturnValue:!0},n._getEvents=function(){return this._events||(this._events={})},e(h,t);var p=h.prototype;p._debug=function(){this._config.debug===!0&&c("debug",arguments)},p._configure=function(e){this._debug("Configuring centrifuge object with",e),e||(e={}),this._config=s(!1,this._config,e);if(!this._config.url)throw"Missing required configuration parameter 'url' specifying the Centrifuge server URL";if(!this._config.token)throw"Missing required configuration parameter 'token' specifying the sign of authorization request";if(!this._config.project)throw"Missing required configuration parameter 'project' specifying project ID in Centrifuge";if(!this._config.user&&this._config.user!=="")throw"Missing required configuration parameter 'user' specifying user's unique ID in your application";if(!this._config.timestamp)throw"Missing required configuration parameter 'timestamp'";this._config.url=a(this._config.url);if(u(this._config.url,"connection")){if(typeof window.SockJS=="undefined")throw"You need to include SockJS client library before Centrifuge javascript client library or use pure Websocket connection endpoint";this._sockjs=!0}},p._setStatus=function(e){this._status!==e&&(this._debug("Status",this._status,"->",e),this._status=e)},p._isDisconnected=function(){return this._isConnected()===!1},p._isConnected=function(){return this._status==="connected"},p._nextMessageId=function(){return++this._messageId},p._clearSubscriptions=function(){this._subscriptions={}},p._send=function(
e){for(var t=0;t<e.length;++t){var n=e[t];n.uid=""+this._nextMessageId(),this._clientId&&(n.clientId=this._clientId),this._debug("Send",n),this._transport.send(JSON.stringify(n))}},p._connect=function(e){this._clientId=null,this._reconnect=!0,this._clearSubscriptions(),this._setStatus("connecting");var t=this;e&&this.on("connect",e);if(this._sockjs===!0){var n={protocols_whitelist:this._config.protocols_whitelist};this._config.server!==null&&(n.server=this._config.server),this._transport=new SockJS(this._config.url,null,n)}else this._transport=new WebSocket(this._config.url);this._setStatus("connecting"),this._transport.onopen=function(){var e={method:"connect",params:{token:t._config.token,user:t._config.user,project:t._config.project,timestamp:t._config.timestamp}};t._config.info!==null?(t._debug("connect using additional info"),e.params.info=t._config.info):t._debug("connect without additional info"),t.send(e)},this._transport.onerror=function(e){t._debug(e)},this._transport.onclose=function(){t._setStatus("disconnected"),t.trigger("disconnect"),t._reconnect===!0&&window.setTimeout(function(){t._reconnect===!0&&t._connect.call(t)},t._config.retry)},this._transport.onmessage=function(e){var n;n=JSON.parse(e.data),t._debug("Received",n),t._receive(n)}},p._disconnect=function(){this._clientId=null,this._setStatus("disconnected"),this._subscriptions={},this._reconnect=!1,this._transport.close()},p._getSubscription=function(e){var t;return t=this._subscriptions[e],t?t:null},p._removeSubscription=function(e){try{delete this._subscriptions[e]}catch(t){this._debug("nothing to delete for channel ",e)}},p._connectResponse=function(e){e.error===null?(this._clientId=e.body,this._setStatus("connected"),this.trigger("connect",[e])):(this.trigger("error",[e]),this.trigger("connect:error",[e]))},p._disconnectResponse=function(e){e.error===null?this.disconnect():(this.trigger("error",[e]),this.trigger("disconnect:error",[e.error]))},p._subscribeResponse=function(e){e.error!==null&&this.trigger("error",[e]);var t=e.body;if(t===null)return;var n=t.channel,r=this.getSubscription(n);if(!r)return;e.error===null?(r.trigger("subscribe:success",[t]),r.trigger("ready",[t])):(r.trigger("subscribe:error",[e.error]),r.trigger("error",[e]))},p._unsubscribeResponse=function(e){var t=e.body,n=t.channel,r=this.getSubscription(n);if(!r)return;e.error===null&&(r.trigger("unsubscribe",[t]),this._centrifuge._removeSubscription(n))},p._publishResponse=function(e){var t=e.body,n=t.channel,r=this.getSubscription(n);if(!r)return;e.error===null?r.trigger("publish:success",[t]):(r.trigger("publish:error",[e.error]),this.trigger("error",[e]))},p._presenceResponse=function(e){var t=e.body,n=t.channel,r=this.getSubscription(n);if(!r)return;e.error===null?(r.trigger("presence",[t]),r.trigger("presence:success",[t])):(r.trigger("presence:error",[e.error]),this.trigger("error",[e]))},p._historyResponse=function(e){var t=e.body,n=t.channel,r=this.getSubscription(n);if(!r)return;e.error===null?(r.trigger("history",[t]),r.trigger("history:success",[t])):(r.trigger("history:error",[e.error]),this.trigger("error",[e]))},p._joinResponse=function(e){var t=e.body,n=t.channel,r=this.getSubscription(n);if(!r)return;r.trigger("join",[t])},p._leaveResponse=function(e){var t=e.body,n=t.channel,r=this.getSubscription(n);if(!r)return;r.trigger("leave",[t])},p._messageResponse=function(e){var t=e.body,n=t.channel,r=this.getSubscription(n);if(r===null)return;r.trigger("message",[t])},p._dispatchMessage=function(e){if(e===undefined||e===null)return;var t=e.method;if(!t)return;switch(t){case"connect":this._connectResponse(e);break;case"disconnect":this._disconnectResponse(e);break;case"subscribe":this._subscribeResponse(e);break;case"unsubscribe":this._unsubscribeResponse(e);break;case"publish":this._publishResponse(e);break;case"presence":this._presenceResponse(e);break;case"history":this._historyResponse(e);break;case"join":this._joinResponse(e);break;case"leave":this._leaveResponse(e);break;case"ping":break;case"message":this._messageResponse(e);break;default:}},p._receive=function(e){if(Object.prototype.toString.call(e)===Object.prototype.toString.call([])){for(var t in e)if(e.hasOwnProperty(t)){var n=e[t];this._dispatchMessage(n)}}else Object.prototype.toString.call(e)===Object.prototype.toString.call({})&&this._dispatchMessage(e)},p._flush=function(){var e=this._messages.slice(0);this._messages=[],this._send(e)},p._ping=function(){var e={method:"ping",params:{}};this.send(e)},p.getClientId=function(){return this._clientId},p.isConnected=p._isConnected,p.isDisconnected=p._isDisconnected,p.configure=function(e){this._configure.call(this,e)},p.connect=p._connect,p.disconnect=p._disconnect,p.getSubscription=p._getSubscription,p.ping=p._ping,p.send=function(e){this._isBatching===!0?this._messages.push(e):this._send([e])},p.startBatching=function(){this._isBatching=!0},p.stopBatching=function(e){e=e||!1,this._isBatching=!1,e===!0&&this.flush()},p.flush=function(){this._flush()},p.subscribe=function(e,t){if(arguments.length<1)throw"Illegal arguments number: required 1, got "+arguments.length;if(!f(e))throw"Illegal argument type: channel must be a string";if(this.isDisconnected())throw"Illegal state: already disconnected";var n=this.getSubscription(e);if(n!==null)return n;var r=new d(this,e);return this._subscriptions[e]=r,r.subscribe(t),r},p.unsubscribe=function(e){if(arguments.length<1)throw"Illegal arguments number: required 1, got "+arguments.length;if(!f(e))throw"Illegal argument type: channel must be a string";if(this.isDisconnected())return;var t=this.getSubscription(e);t!==null&&t.unsubscribe()},p.publish=function(e,t,n){var r=this.getSubscription(e);return r===null?(this._debug("subscription not found for channel "+e),null):(r.publish(t,n),r)},p.presence=function(e,t){var n=this.getSubscription(e);return n===null?(this._debug("subscription not found for channel "+e),null):(n.presence(t),n)},p.history=function(e,t){var n=this.getSubscription(e);return n===
null?(this._debug("subscription not found for channel "+e),null):(n.history(t),n)},e(d,t);var v=d.prototype;v.getChannel=function(){return this.channel},v.getCentrifuge=function(){return this._centrifuge},v.subscribe=function(e){var t={method:"subscribe",params:{channel:this.channel}};this._centrifuge.send(t),e&&this.on("message",e)},v.unsubscribe=function(){this._centrifuge._removeSubscription(this.channel);var e={method:"unsubscribe",params:{channel:this.channel}};this._centrifuge.send(e)},v.publish=function(e,t){var n={method:"publish",params:{channel:this.channel,data:e}};t&&this.on("publish:success",t),this._centrifuge.send(n)},v.presence=function(e){var t={method:"presence",params:{channel:this.channel}};e&&this.on("presence",e),this._centrifuge.send(t)},v.history=function(e){var t={method:"history",params:{channel:this.channel}};e&&this.on("history",e),this._centrifuge.send(t)},typeof define=="function"&&define.amd?define(function(){return h}):typeof module=="object"&&module.exports?module.exports=h:this.Centrifuge=h}).call(this);
